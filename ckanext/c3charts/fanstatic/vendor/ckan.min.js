var CKAN={};var isNodeModule=(typeof module!=='undefined'&&module!=null&&typeof require!=='undefined');if(isNodeModule){var _=require('underscore'),request=require('request');module.exports=CKAN;}
(function(my){my.Client=function(endpoint,apiKey){this.endpoint=_getEndpoint(endpoint);this.apiKey=apiKey;};my.Client.prototype.action=function(name,data,cb){if(name.indexOf('dataset_'===0)){name=name.replace('dataset_','package_');}
var options={url:this.endpoint+'/3/action/'+name,data:data,type:'POST'};return this._ajax(options,cb);};my.Client.prototype._ajax=function(options,cb){options.headers=options.headers||{};if(this.apiKey){options.headers['X-CKAN-API-KEY']=this.apiKey;}
var meth=isNodeModule?_nodeRequest:_browserRequest;return meth(options,cb);}
my.Client.prototype.datastoreQuery=function(queryObj,cb){var actualQuery=my._normalizeQuery(queryObj);this.action('datastore_search',actualQuery,function(err,results){if(err){cb(err);return;}
var fields=_.map(results.result.fields,function(field){field.type=field.type in my.ckan2JsonTableSchemaTypes?my.ckan2JsonTableSchemaTypes[field.type]:field.type;return field;});var out={total:results.result.total,fields:fields,hits:results.result.records};cb(null,out);});};my.Client.prototype.datastoreSqlQuery=function(sql,cb){this.action('datastore_search_sql',{sql:sql},function(err,results){if(err){var parsed=JSON.parse(err.message);var errOut={original:err,code:err.code,message:parsed.error.info.orig[0]};cb(errOut);return;}
var fields=_.map(results.result.fields,function(field){field.type=field.type in my.ckan2JsonTableSchemaTypes?my.ckan2JsonTableSchemaTypes[field.type]:field.type;return field;});var out={total:results.result.length,fields:fields,hits:results.result.records};cb(null,out);});};my.ckan2JsonTableSchemaTypes={'text':'string','int':'integer','int4':'integer','int8':'integer','float8':'float','timestamp':'datetime','bool':'boolean',};my.jsonTableSchema2CkanTypes={'string':'text','number':'float','integer':'int','datetime':'timestamp','boolean':'bool','binary':'bytea','object':'json','array':'text[]','any':'text'};my.Client.prototype.datastoreResources=function(cb){var data={resource_id:'_table_metadata'};return this.action('datastore_search',data,cb);};var _getEndpoint=function(endpoint){endpoint=endpoint||'/';endpoint=endpoint.replace(/\/$/,'');if(!endpoint.match(/\/api$/)){endpoint+='/api';}
return endpoint;};var _nodeRequest=function(options,cb){var conf={url:options.url,headers:options.headers||{},method:options.type||'GET',json:options.data};request(conf,function(err,res,body){if(!err&&res&&!(res.statusCode===200||res.statusCode===302)){err='CKANJS API Error. HTTP code '+res.statusCode+'. Message: '+JSON.stringify(body,null,2);}
cb(err,body);});};var _browserRequest=function(options,cb){var self=this;options.data=encodeURIComponent(JSON.stringify(options.data));options.success=function(data){cb(null,data);}
options.error=function(obj,obj2,obj3){var err={code:obj.status,message:obj.responseText}
cb(err);}
if(options.headers){options.beforeSend=function(req){for(key in options.headers){req.setRequestHeader(key,options.headers[key]);}};}
return jQuery.ajax(options);};my._normalizeQuery=function(queryObj){var actualQuery={resource_id:queryObj.resource_id,q:queryObj.q,filters:{},limit:queryObj.size||10,offset:queryObj.from||0};if(queryObj.sort&&queryObj.sort.length>0){var _tmp=_.map(queryObj.sort,function(sortObj){return sortObj.field+' '+(sortObj.order||'');});actualQuery.sort=_tmp.join(',');}
if(queryObj.filters&&queryObj.filters.length>0){_.each(queryObj.filters,function(filter){if(filter.type==="term"){actualQuery.filters[filter.field]=filter.term;}});}
return actualQuery;};my.parseCkanResourceUrl=function(url){parts=url.split('/');var len=parts.length;return{resource_id:parts[len-1],endpoint:parts.slice(0,[len-4]).join('/')+'/api'};};}(CKAN));var recline=recline||{};recline.Backend=recline.Backend||{};recline.Backend.Ckan=recline.Backend.Ckan||{};(function(my){my.__type__='ckan';var Deferred=_.isUndefined(this.jQuery)?_.Deferred:jQuery.Deferred;my.fetch=function(dataset){var dfd=new Deferred()
my.query({},dataset).done(function(data){dfd.resolve({fields:data.fields,records:data.hits});}).fail(function(err){dfd.reject(err);});return dfd.promise();};my.query=function(queryObj,dataset){var dfd=new Deferred(),wrapper;if(dataset.endpoint){wrapper=new CKAN.Client(dataset.endpoint);}else{var out=CKAN.parseCkanResourceUrl(dataset.url);dataset.id=out.resource_id;wrapper=new CKAN.Client(out.endpoint);}
queryObj.resource_id=dataset.id;wrapper.datastoreQuery(queryObj,function(err,out){if(err){dfd.reject(err);}else{dfd.resolve(out);}});return dfd.promise();};}(recline.Backend.Ckan));